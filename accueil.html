<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WorkHub Dashboard </title>
    <link rel="stylesheet" href="accueil.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Confetti Library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  
</head>
<body class="text-white overflow-hidden selection:bg-[#FF9900] selection:text-white">

    <div class="flex h-screen w-full">
        
        <!-- SIDEBAR -->
        <aside class="w-64 flex-shrink-0 flex flex-col border-r border-white/5 bg-[#0a0a0a]">
            <div class="h-20 flex items-center px-6">
                <div class="flex items-center text-2xl tracking-tighter cursor-pointer group select-none" onclick="location.reload()">
                    <span class="font-bold text-white group-hover:text-gray-200 transition-colors">WORK</span>
                    <span class="ml-1 px-2 py-0.5 rounded text-sm font-bold flex items-center justify-center transition-transform group-hover:scale-105 shadow-[0_0_20px_rgba(255,153,0,0.3)] bg-gradient-to-r from-[#FF9900] to-[#ff7b00] text-white">HUB</span>
                </div>
            </div>

            <nav class="flex-1 py-6 space-y-1" id="sidebar-nav"></nav>

            <div class="p-4 border-t border-white/5 bg-[#0a0a0a]">
                <div class="flex items-center space-x-3 cursor-pointer hover:bg-white/5 p-2 rounded-xl transition-colors group border border-transparent hover:border-white/5">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-gray-700 to-gray-800 flex items-center justify-center border border-white/10 group-hover:border-[#FF9900] transition-colors relative shadow-lg">
                        <span class="font-bold text-sm">JD</span>
                        <div class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 rounded-full border-2 border-[#121212]"></div>
                    </div>
                    <div class="overflow-hidden">
                        <div class="text-sm font-bold truncate group-hover:text-[#FF9900] transition-colors">Melvyn</div>
                        <div class="text-[10px] text-gray-500 uppercase tracking-wider font-semibold">Chef de Projet</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 flex flex-col overflow-hidden relative bg-black bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-gray-900 via-black to-black">
            
            <!-- Header -->
            <header class="h-20 flex items-center justify-between px-8 border-b border-white/5 glass-panel z-10 sticky top-0">
                <div class="w-1/3 group">
                    <div class="relative transition-all duration-300 transform focus-within:scale-105">
                        <input type="text" id="search-input" placeholder="Rechercher (CMD+K)..." 
                            class="w-full bg-[#0a0a0a] text-white pl-10 pr-4 py-2.5 rounded-xl border border-white/10 focus:outline-none focus:border-[#FF9900]/50 focus:bg-[#121212] focus:shadow-[0_0_20px_rgba(255,153,0,0.15)] transition-all duration-300 text-sm font-medium placeholder-gray-600">
                        <i data-lucide="search" class="absolute left-3 top-2.5 text-gray-600 w-4 h-4 group-focus-within:text-[#FF9900] transition-colors"></i>
                    </div>
                </div>

                <div class="flex items-center space-x-4">
                    <button onclick="handleSmartBriefing()" class="flex items-center px-4 py-2 rounded-lg border border-[#FF9900]/30 text-[#FF9900] text-xs font-bold uppercase tracking-wider hover:bg-[#FF9900] hover:text-white transition-all duration-300 shadow-[0_0_15px_rgba(255,153,0,0.05)] hover:shadow-[0_0_25px_rgba(255,153,0,0.4)] group">
                        <i data-lucide="sparkles" class="w-3.5 h-3.5 mr-2 group-hover:rotate-12 transition-transform"></i> Smart Briefing
                    </button>

                    <button class="relative p-2.5 rounded-lg text-gray-400 hover:text-white hover:bg-white/5 transition-colors" id="notif-btn">
                        <i data-lucide="bell" class="w-5 h-5"></i>
                        <span id="notif-badge" class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full ring-2 ring-black hidden"></span>
                    </button>
                    
                    <button onclick="openTaskModal()" class="flex items-center px-6 py-2.5 rounded-xl font-bold text-sm tracking-wide transform hover:scale-105 active:scale-95 transition-all shadow-[0_4px_20px_-5px_rgba(255,153,0,0.5)] bg-gradient-to-r from-[#FF9900] to-[#ff7b00] text-white">
                        <i data-lucide="plus" class="w-4.5 h-4.5 mr-2 stroke-[3]"></i> TÂCHE
                    </button>
                </div>
            </header>

            <!-- Dashboard Body -->
            <div id="dashboard-content" class="flex-1 overflow-y-auto p-8 custom-scrollbar relative">
                
                <!-- Metrics Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10" id="metrics-container"></div>

                <!-- Kanban Header -->
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold tracking-tight text-white flex items-center">
                        <div class="p-2 bg-[#FF9900]/10 rounded-lg mr-3">
                            <i data-lucide="layout-dashboard" class="text-[#FF9900] w-5 h-5"></i>
                        </div>
                        Sprint Actuel
                    </h2>
                    <div class="flex space-x-3 items-center">
                        <button onclick="resetData()" class="text-xs font-bold text-gray-600 hover:text-red-500 transition-colors uppercase tracking-wider px-3 py-1">Reset</button>
                        <div class="h-4 w-[1px] bg-white/10"></div>
                        <div class="flex -space-x-2 overflow-hidden px-2">
                            <div class="inline-block h-8 w-8 rounded-full ring-2 ring-black bg-gray-700 flex items-center justify-center text-xs font-bold shadow-lg">JD</div>
                            <div class="inline-block h-8 w-8 rounded-full ring-2 ring-black bg-gray-600 flex items-center justify-center text-xs font-bold shadow-lg">+2</div>
                        </div>
                        <button class="text-gray-400 hover:text-white font-medium text-sm flex items-center bg-[#1E1E1E] px-3 py-1.5 rounded-lg border border-white/5 hover:border-white/20 transition-all shadow-sm">
                            <i data-lucide="filter" class="w-3.5 h-3.5 mr-2"></i> Filtres
                        </button>
                    </div>
                </div>

                <!-- Kanban Board -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 h-full pb-20">
                    <div class="flex flex-col h-full kanban-column p-3 border border-transparent" id="col-todo" ondrop="drop(event, 'todo')" ondragover="allowDrop(event)"></div>
                    <div class="flex flex-col h-full kanban-column p-3 border border-transparent" id="col-in-progress" ondrop="drop(event, 'in-progress')" ondragover="allowDrop(event)"></div>
                    <div class="flex flex-col h-full kanban-column p-3 border border-transparent" id="col-done" ondrop="drop(event, 'done')" ondragover="allowDrop(event)"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- AI Modal -->
    <div id="ai-modal" class="fixed inset-0 bg-black/80 backdrop-blur-md z-50 flex items-center justify-center p-4 hidden opacity-0 transition-opacity duration-300">
        <div class="w-full max-w-lg rounded-2xl glass-modal flex flex-col max-h-[80vh] transform scale-95 transition-transform duration-300" id="ai-modal-content">
            <div class="p-5 border-b border-white/10 flex items-center justify-between bg-white/5">
                <h3 class="text-[#FF9900] font-bold flex items-center tracking-wider text-sm" id="ai-modal-title"><i data-lucide="sparkles" class="w-4 h-4 mr-2"></i> INTELLIGENCE ARTIFICIELLE</h3>
                <button onclick="closeAiModal()" class="text-gray-400 hover:text-white transition-colors bg-white/5 p-1 rounded-full hover:bg-white/10"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <div class="p-8 overflow-y-auto custom-scrollbar min-h-[200px]">
                <div id="ai-loading" class="flex flex-col items-center justify-center py-10 space-y-4 hidden">
                    <div class="relative">
                        <i data-lucide="loader" class="w-10 h-10 text-[#FF9900] spin"></i>
                        <div class="absolute inset-0 bg-[#FF9900] blur-xl opacity-20 animate-pulse"></div>
                    </div>
                    <p class="text-gray-400 text-xs font-bold tracking-widest animate-pulse">ANALYSE DES DONNÉES...</p>
                </div>
                <div id="ai-result" class="prose prose-invert prose-sm max-w-none text-gray-200 whitespace-pre-line leading-relaxed hidden font-light"></div>
            </div>
            <div class="p-5 border-t border-white/10 bg-black/20 text-right">
                <button onclick="closeAiModal()" class="px-5 py-2 bg-white/5 hover:bg-white/10 rounded-lg text-sm font-bold text-white border border-white/5 transition-all">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Task Modal (Create/Edit) -->
    <div id="task-modal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden opacity-0 transition-opacity duration-300">
        <div class="w-full max-w-md rounded-2xl glass-modal flex flex-col transform scale-95 transition-transform duration-300">
            <div class="p-6 border-b border-white/10 flex items-center justify-between">
                <h3 class="text-white font-bold tracking-wide text-lg" id="modal-title">NOUVELLE TÂCHE</h3>
                <button onclick="closeTaskModal()" class="text-gray-500 hover:text-white transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-5">
                <input type="hidden" id="task-id">
                
                <!-- Titre -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5 ml-1">Titre de la tâche</label>
                    <input type="text" id="task-title" class="w-full bg-[#0a0a0a] border border-white/10 rounded-xl p-3 text-white focus:border-[#FF9900] focus:ring-1 focus:ring-[#FF9900] focus:outline-none transition-all placeholder-gray-700 font-medium" placeholder="Ex: Refonte Homepage">
                </div>

                <!-- Description (Nouveau) -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5 ml-1">Description</label>
                    <textarea id="task-desc" rows="3" class="w-full bg-[#0a0a0a] border border-white/10 rounded-xl p-3 text-white focus:border-[#FF9900] focus:ring-1 focus:ring-[#FF9900] focus:outline-none transition-all placeholder-gray-700 text-sm resize-none custom-scrollbar" placeholder="Détails, contexte, spécifications..."></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <!-- Projet -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5 ml-1">Projet</label>
                        <div class="relative">
                            <i data-lucide="folder" class="absolute left-3 top-3 w-4 h-4 text-gray-600"></i>
                            <input type="text" id="task-project" class="w-full bg-[#0a0a0a] border border-white/10 rounded-xl pl-10 p-3 text-white focus:border-[#FF9900] focus:outline-none transition-all placeholder-gray-700 text-sm" placeholder="Marketing">
                        </div>
                    </div>
                    <!-- Priorité -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5 ml-1">Priorité</label>
                        <div class="relative">
                            <select id="task-priority" class="w-full bg-[#0a0a0a] border border-white/10 rounded-xl p-3 text-white focus:border-[#FF9900] focus:outline-none transition-all appearance-none text-sm cursor-pointer">
                                <option value="low">Basse</option>
                                <option value="normal" selected>Normale</option>
                                <option value="high">Haute</option>
                                <option value="urgent">Urgente</option>
                            </select>
                            <i data-lucide="chevron-down" class="absolute right-3 top-3.5 w-4 h-4 text-gray-600 pointer-events-none"></i>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                     <!-- Tags (Nouveau) -->
                     <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5 ml-1">Tags (séparés par virgule)</label>
                        <input type="text" id="task-tags" class="w-full bg-[#0a0a0a] border border-white/10 rounded-xl p-3 text-white focus:border-[#FF9900] focus:outline-none transition-all placeholder-gray-700 text-sm" placeholder="Bug, UI, V2">
                    </div>
                    <!-- Date -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1.5 ml-1">Échéance</label>
                        <input type="date" id="task-date" class="w-full bg-[#0a0a0a] border border-white/10 rounded-xl p-3 text-white focus:border-[#FF9900] focus:outline-none color-scheme-dark text-sm cursor-pointer">
                    </div>
                </div>

            </div>
            <div class="p-6 border-t border-white/10 flex justify-end space-x-3 bg-white/5 rounded-b-2xl">
                <button onclick="closeTaskModal()" class="px-5 py-2.5 text-gray-400 hover:text-white font-medium text-sm transition-colors">Annuler</button>
                <button onclick="saveTask()" class="px-8 py-2.5 bg-gradient-to-r from-[#FF9900] to-[#ff7b00] hover:from-[#ff8800] hover:to-[#ff6600] text-white font-bold rounded-xl text-sm shadow-lg transform hover:scale-105 transition-all">ENREGISTRER</button>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- DATA ---
        const INITIAL_TASKS = [
            { id: 1, title: "Refonte de l'interface utilisateur", description: "Moderniser le dashboard avec un style glassmorphism et des animations fluides.", project: "Projet Alpha", priority: "high", status: "todo", date: new Date(Date.now() + 86400000).toISOString().split('T')[0], comments: 3, attachments: 1, tags: ["UI", "Design"] },
            { id: 2, title: "Analyse des données Q3", description: "Extraire les KPIs principaux et préparer la présentation pour le board.", project: "Finance", priority: "normal", status: "todo", date: "2024-11-28", comments: 0, attachments: 2, tags: ["Data", "Report"] },
            { id: 3, title: "Correction bug critique API", description: "L'endpoint /users renvoie une erreur 500 sur les payloads > 1Mb.", project: "Backend", priority: "urgent", status: "in-progress", date: new Date(Date.now() - 86400000).toISOString().split('T')[0], comments: 12, attachments: 4, tags: ["Bug", "Urgent"] },
            { id: 4, title: "Maquettes Mobile", description: "Finaliser les écrans de connexion et de profil.", project: "Design", priority: "normal", status: "done", date: new Date(Date.now() - 172800000).toISOString().split('T')[0], comments: 8, attachments: 6, tags: ["Mobile", "Figma"] }
        ];

        let tasks = JSON.parse(localStorage.getItem('workhub_tasks_v2')) || [...INITIAL_TASKS];
        let searchTerm = "";
        const apiKey = ""; 

        // --- HELPERS ---
        function saveState() {
            localStorage.setItem('workhub_tasks_v2', JSON.stringify(tasks));
            renderKanban();
            renderMetrics();
        }

        function resetData() {
            if(confirm("Réinitialiser toutes les données aux valeurs par défaut ?")) {
                tasks = [...INITIAL_TASKS];
                saveState();
                showToast("Données réinitialisées", "info");
                setTimeout(() => location.reload(), 1000);
            }
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = '';
            if (type === 'success') icon = '<i data-lucide="check-circle" class="w-5 h-5 mr-3 text-green-500"></i>';
            if (type === 'error') icon = '<i data-lucide="alert-circle" class="w-5 h-5 mr-3 text-red-500"></i>';
            if (type === 'info') icon = '<i data-lucide="info" class="w-5 h-5 mr-3 text-blue-500"></i>';

            toast.innerHTML = `${icon} <span>${message}</span>`;
            container.appendChild(toast);
            lucide.createIcons();

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-in forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function triggerConfetti() {
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#FF9900', '#ffffff', '#333333']
            });
        }

        function formatDateDisplay(dateString) {
            if (!dateString) return "Aucune date";
            const date = new Date(dateString);
            const today = new Date();
            today.setHours(0,0,0,0);
            date.setHours(0,0,0,0);
            
            const diffTime = date - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return "Aujourd'hui";
            if (diffDays === 1) return "Demain";
            if (diffDays === -1) return "Hier";
            if (diffDays < 0) return "En retard";
            
            return new Intl.DateTimeFormat('fr-FR', { day: 'numeric', month: 'short' }).format(date);
        }

        function isOverdue(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            today.setHours(0,0,0,0);
            return date < today && dateString !== "";
        }

        // --- RENDER ---
        function renderSidebar() {
            const nav = document.getElementById('sidebar-nav');
            const items = [
                { icon: 'layout-dashboard', label: 'Tableau de Bord', active: true },
                { icon: 'check-square', label: 'Mes Tâches', active: false },
                { icon: 'users', label: 'Équipes', active: false },
                { separator: true, label: 'Système' },
                { icon: 'settings', label: 'Paramètres', active: false }
            ];

            nav.innerHTML = items.map(item => {
                if (item.separator) return `<div class="pt-8 pb-3 px-6 text-[11px] font-extrabold text-gray-600 uppercase tracking-widest">${item.label}</div>`;
                const activeClass = item.active ? 'bg-[#FF9900]/10 text-white border-l-4 border-[#FF9900]' : 'border-l-4 border-transparent text-gray-500 hover:text-white hover:bg-white/5';
                const iconColor = item.active ? 'text-[#FF9900]' : 'text-gray-500 group-hover:text-white';
                return `<div class="flex items-center px-6 py-3.5 cursor-pointer transition-all duration-200 group ${activeClass}">
                            <div class="mr-4 ${iconColor}"><i data-lucide="${item.icon}" class="w-5 h-5"></i></div>
                            <span class="font-bold tracking-wide text-sm">${item.label}</span>
                        </div>`;
            }).join('');
        }

        function renderMetrics() {
            const urgent = tasks.filter(t => t.priority === 'urgent' && t.status !== 'done').length;
            const active = tasks.filter(t => t.status === 'in-progress').length;
            const done = tasks.filter(t => t.status === 'done').length;
            const total = tasks.length;
            const efficiency = total ? Math.round((done / total) * 100) : 0;

            const metrics = [
                { num: urgent, label: "Urgences", sub: "À traiter", color: "#ef4444", icon: "alert-octagon" },
                { num: active, label: "En Cours", sub: "Tâches actives", color: "#3b82f6", icon: "activity" },
                { num: `${efficiency}%`, label: "Efficacité", sub: "Progression globale", color: "#FF9900", icon: "bar-chart-2" },
                { num: total, label: "Total", sub: "Tâches backlog", color: "#10b981", icon: "layers" }
            ];

            document.getElementById('metrics-container').innerHTML = metrics.map(m => `
                <div class="p-6 rounded-2xl glass-panel hover:border-[#FF9900]/50 transition-all duration-300 group cursor-default relative overflow-hidden fade-in">
                    <div class="flex justify-between items-start mb-4">
                        <div class="p-2.5 rounded-xl bg-white/5 group-hover:bg-white/10 transition-colors">
                             <i data-lucide="${m.icon}" class="w-6 h-6" style="color: ${m.color}"></i>
                        </div>
                        <i data-lucide="more-horizontal" class="text-gray-600 hover:text-white cursor-pointer w-5 h-5"></i>
                    </div>
                    <div class="text-3xl font-extrabold tracking-tight mb-1 text-white">${m.num}</div>
                    <div class="text-sm font-bold text-gray-300">${m.label}</div>
                    <div class="text-xs font-medium text-gray-500 mt-1">${m.sub}</div>
                    
                    <!-- Glow -->
                    <div class="absolute -bottom-10 -right-10 w-24 h-24 rounded-full opacity-0 group-hover:opacity-20 blur-2xl transition-opacity duration-500" style="background-color: ${m.color}"></div>
                </div>
            `).join('');
        }

        function renderTaskCard(task) {
            const overdue = isOverdue(task.date) && task.status !== 'done';
            const dateDisplay = formatDateDisplay(task.date);
            const urgentBadge = task.priority === 'urgent' ? `<span class="px-2 py-0.5 rounded text-[10px] font-black uppercase tracking-widest text-white animate-pulse bg-red-600 shadow-sm">URGENT</span>` : '';
            
            // Tags rendering
            let tagsHtml = '';
            if (task.tags && task.tags.length > 0) {
                tagsHtml = `<div class="flex flex-wrap gap-1 mt-3">
                    ${task.tags.map(tag => `<span class="px-2 py-0.5 rounded-md bg-white/5 border border-white/5 text-[10px] text-gray-400 font-medium">${tag}</span>`).join('')}
                </div>`;
            }

            return `
                <div class="task-card p-4 rounded-xl glass-panel border border-white/5 bg-[#1a1a1a] hover:bg-[#222] transition-all cursor-grab group relative fade-in mb-3 select-none"
                     draggable="true" ondragstart="drag(event)" id="${task.id}">
                    
                    <!-- Action Buttons Overlay -->
                    <div class="task-actions absolute top-2 right-2 z-20 flex space-x-1">
                        <button onclick="handleTaskBreakdown('${task.title.replace(/'/g, "\\'")}', '${task.project.replace(/'/g, "\\'")}')" class="p-1.5 rounded-lg bg-blue-600/90 text-white hover:bg-blue-500 backdrop-blur-sm shadow-lg transition-transform hover:scale-105" title="IA Help"><i data-lucide="sparkles" class="w-3.5 h-3.5"></i></button>
                        <button onclick="openTaskModal(${task.id})" class="p-1.5 rounded-lg bg-gray-700/90 text-white hover:bg-gray-600 backdrop-blur-sm shadow-lg transition-transform hover:scale-105" title="Modifier"><i data-lucide="pencil" class="w-3.5 h-3.5"></i></button>
                        <button onclick="deleteTask(${task.id})" class="p-1.5 rounded-lg bg-red-600/90 text-white hover:bg-red-500 backdrop-blur-sm shadow-lg transition-transform hover:scale-105" title="Supprimer"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                    </div>

                    <div class="flex justify-between items-start mb-2 pointer-events-none">
                        <span class="text-[10px] font-bold uppercase tracking-wider text-gray-500 bg-white/5 px-2 py-0.5 rounded">${task.project}</span>
                        ${urgentBadge}
                    </div>
                    
                    <h4 class="font-bold text-sm mb-1 leading-snug pointer-events-none ${task.status === 'done' ? 'text-gray-500 line-through' : 'text-gray-100'}">${task.title}</h4>
                    ${task.description ? `<p class="text-xs text-gray-500 line-clamp-2 mb-2 font-light">${task.description}</p>` : ''}
                    
                    ${tagsHtml}

                    <div class="flex items-center justify-between text-xs text-gray-500 mt-3 border-t border-white/5 pt-3 pointer-events-none">
                        <div class="flex items-center space-x-3">
                            ${task.comments ? `<div class="flex items-center text-gray-400"><i data-lucide="message-square" class="w-3.5 h-3.5 mr-1.5"></i> ${task.comments}</div>` : ''}
                            ${task.attachments ? `<div class="flex items-center text-gray-400"><i data-lucide="paperclip" class="w-3.5 h-3.5 mr-1.5"></i> ${task.attachments}</div>` : ''}
                        </div>
                        <div class="flex items-center font-bold ${overdue ? 'text-red-500' : 'text-gray-400'}">
                            <i data-lucide="clock" class="w-3.5 h-3.5 mr-1.5"></i> ${dateDisplay}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderKanban() {
            const filtered = tasks.filter(t => 
                t.title.toLowerCase().includes(searchTerm) || 
                t.project.toLowerCase().includes(searchTerm) ||
                (t.tags && t.tags.some(tag => tag.toLowerCase().includes(searchTerm)))
            );
            
            const cols = [
                { id: 'col-todo', title: 'À FAIRE', status: 'todo' },
                { id: 'col-in-progress', title: 'EN COURS', status: 'in-progress' },
                { id: 'col-done', title: 'TERMINÉ', status: 'done' }
            ];

            cols.forEach(col => {
                const items = filtered.filter(t => t.status === col.status);
                document.getElementById(col.id).innerHTML = `
                    <div class="flex items-center justify-between mb-4 pb-2 border-b border-white/5 pointer-events-none px-2">
                        <h3 class="font-bold tracking-wider text-xs text-gray-400 uppercase flex items-center">
                            <span class="w-2 h-2 rounded-full mr-2 ${col.status === 'todo' ? 'bg-gray-500' : col.status === 'in-progress' ? 'bg-blue-500' : 'bg-green-500'}"></span>
                            ${col.title}
                        </h3>
                        <span class="bg-white/5 text-gray-400 px-2 py-0.5 rounded text-[10px] font-bold border border-white/5">${items.length}</span>
                    </div>
                    <div class="flex-1 space-y-3 min-h-[150px]">
                        ${items.map(renderTaskCard).join('')}
                        ${items.length === 0 ? `
                            <div class="text-gray-700 text-xs text-center border-2 border-dashed border-white/5 rounded-xl p-4 h-32 flex flex-col items-center justify-center transition-colors hover:border-white/10 hover:bg-white/5">
                                <i data-lucide="ghost" class="w-6 h-6 mb-2 opacity-20"></i>
                                Vide
                            </div>` : ''}
                    </div>
                `;
            });
            lucide.createIcons();
        }

        // --- ACTIONS (CRUD) ---
        function openTaskModal(id = null) {
            const modal = document.getElementById('task-modal');
            const titleEl = document.getElementById('modal-title');
            
            // Reset form
            document.getElementById('task-id').value = "";
            document.getElementById('task-title').value = "";
            document.getElementById('task-desc').value = "";
            document.getElementById('task-project').value = "";
            document.getElementById('task-priority').value = "normal";
            document.getElementById('task-tags').value = "";
            document.getElementById('task-date').value = new Date().toISOString().split('T')[0];

            if (id) {
                const task = tasks.find(t => t.id === id);
                if (task) {
                    titleEl.innerText = "MODIFIER LA TÂCHE";
                    document.getElementById('task-id').value = task.id;
                    document.getElementById('task-title').value = task.title;
                    document.getElementById('task-desc').value = task.description || "";
                    document.getElementById('task-project').value = task.project;
                    document.getElementById('task-priority').value = task.priority;
                    document.getElementById('task-tags').value = task.tags ? task.tags.join(', ') : "";
                    document.getElementById('task-date').value = task.date;
                }
            } else {
                titleEl.innerText = "NOUVELLE TÂCHE";
            }

            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.children[0].classList.replace('scale-95', 'scale-100');
            }, 10);
            document.getElementById('task-title').focus();
        }

        function closeTaskModal() {
            const modal = document.getElementById('task-modal');
            modal.classList.add('opacity-0');
            modal.children[0].classList.replace('scale-100', 'scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function saveTask() {
            const id = document.getElementById('task-id').value;
            const title = document.getElementById('task-title').value;
            const desc = document.getElementById('task-desc').value;
            const project = document.getElementById('task-project').value;
            const priority = document.getElementById('task-priority').value;
            const date = document.getElementById('task-date').value;
            const tagsInput = document.getElementById('task-tags').value;
            
            // Process Tags
            const tags = tagsInput.split(',').map(t => t.trim()).filter(t => t.length > 0);

            if (!title) {
                showToast("Le titre est requis", "error");
                return;
            }

            if (id) {
                // Edit existing
                const index = tasks.findIndex(t => t.id == id);
                if (index > -1) {
                    tasks[index] = { ...tasks[index], title, description: desc, project, priority, date, tags };
                    showToast("Tâche modifiée avec succès", "success");
                }
            } else {
                // Create new
                const newTask = {
                    id: Date.now(),
                    title,
                    description: desc,
                    project: project || "Général",
                    priority,
                    date: date || new Date().toISOString().split('T')[0],
                    status: 'todo',
                    comments: 0,
                    attachments: 0,
                    tags: tags
                };
                tasks.unshift(newTask);
                showToast("Nouvelle tâche créée", "success");
            }

            saveState();
            closeTaskModal();
        }

        function deleteTask(id) {
            if (confirm("Supprimer cette tâche définitivement ?")) {
                tasks = tasks.filter(t => t.id !== id);
                saveState();
                showToast("Tâche supprimée", "info");
            }
        }

        // --- DRAG & DROP ---
        function allowDrop(ev) { ev.preventDefault(); ev.currentTarget.classList.add('drag-over'); }
        document.addEventListener('dragleave', e => { if(e.target.classList?.contains('kanban-column')) e.target.classList.remove('drag-over'); });
        function drag(ev) { ev.dataTransfer.setData("text", ev.target.id); ev.target.classList.add('dragging'); }
        
        function drop(ev, status) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('drag-over');
            const id = ev.dataTransfer.getData("text");
            const el = document.getElementById(id);
            if(el) el.classList.remove('dragging');
            
            const idx = tasks.findIndex(t => t.id == id);
            if (idx > -1 && tasks[idx].status !== status) {
                tasks[idx].status = status;
                saveState();
                
                if (status === 'done') {
                    triggerConfetti();
                    showToast("Tâche terminée ! Bravo !", "success");
                }
            }
        }

        // --- SEARCH ---
        document.getElementById('search-input').addEventListener('input', e => { searchTerm = e.target.value.toLowerCase(); renderKanban(); });

        // --- AI ---
        async function callGemini(prompt, title) {
            const modal = document.getElementById('ai-modal');
            const resultEl = document.getElementById('ai-result');
            const loadingEl = document.getElementById('ai-loading');
            
            document.getElementById('ai-modal-title').innerHTML = `<i data-lucide="sparkles" class="w-4 h-4 mr-2"></i> ${title}`;
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); modal.children[0].classList.replace('scale-95', 'scale-100'); }, 10);
            
            resultEl.classList.add('hidden');
            loadingEl.classList.remove('hidden');

            try {
                let text = "Clé API manquante ou erreur.";
                if (apiKey) {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await res.json();
                    text = data.candidates?.[0]?.content?.parts?.[0]?.text || "Pas de réponse.";
                } else {
                    await new Promise(r => setTimeout(r, 1200));
                    text = title.includes("BRIEFING") 
                        ? `**BRIEFING INTELLIGENT**\n\n• **URGENCES:** ${tasks.filter(t=>t.priority==='urgent').length} tâches critiques identifiées.\n• **EFFICACITÉ:** ${Math.round(Math.random()*20+70)}% - L'équipe maintient un bon rythme.\n• **RECOMMANDATION:** Priorisez les tickets Backend pour débloquer l'équipe Frontend.\n` 
                        : `**PLAN D'ACTION**\n\n1. <strong>Analyse:</strong> Vérifier les spécifications techniques.\n2. <strong>Dev:</strong> Implémenter la solution en environnement de test.\n3. <strong>QA:</strong> Valider les cas limites.\n4. <strong>Deploy:</strong> Mise en production.`;
                }
                resultEl.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<strong class="text-[#FF9900]">$1</strong>').replace(/•/g, '<br>•');
            } catch (e) { resultEl.innerText = "Erreur: " + e.message; }
            finally { loadingEl.classList.add('hidden'); resultEl.classList.remove('hidden'); }
        }

        function closeAiModal() {
            const modal = document.getElementById('ai-modal');
            modal.classList.add('opacity-0');
            modal.children[0].classList.replace('scale-100', 'scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function handleSmartBriefing() { callGemini(`Briefing executif pour ${tasks.length} tâches.`, "SMART BRIEFING"); }
        function handleTaskBreakdown(t, p) { callGemini(`Checklist pour la tâche "${t}" du projet ${p}.`, `STRATÉGIE: ${t.toUpperCase()}`); }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            renderSidebar(); renderMetrics(); renderKanban(); lucide.createIcons();
            
            // CMD+K Shortcut for search
            document.addEventListener('keydown', (e) => {
                if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                    e.preventDefault();
                    document.getElementById('search-input').focus();
                }
            });
        });
    </script>
</body>
</html>